#!/bin/bash

ISSHELL=0
NOTINTERACTIVESHELL=0
POSITIONAL_ARGS=()

ARGS_TO_COMMAND=()

while [[ $# -gt 0 ]]; do
    if [[ "$ISSHELL" == "1" ]]; then
        NOTINTERACTIVESHELL=1
        break
    fi
    case $1 in
        -s)
            ANDROID_SERIAL="$2"
            POSITIONAL_ARGS+=("$1")
            ARGS_TO_COMMAND+=("$1")
            shift # past argument
            POSITIONAL_ARGS+=("$1")
            ARGS_TO_COMMAND+=("$1")
            shift # past value
            ;;
        shell)
            ISSHELL=1
            POSITIONAL_ARGS+=("$1")
            shift # past value
            ;;
        devices|help|version|connect|disconnect|forward|ppp|reverse|push|pull|sync|emu|install|uninstall|backup|restore|bugreport|jdwp|logcat|disable-verity|enable-verity|keygen|wait-for-usb-device|wait-for-usb-recovery|wait-for-usb-sideload|wait-for-usb-bootloader|wait-for-local-device|wait-for-local-recovery|wait-for-local-sideload|wait-for-local-bootloader|wait-for-any-device|wait-for-any-recovery|wait-for-any-sideload|wait-for-any-bootloader|get-state|get-serialno|get-devpath|remount|reboot|sideload|root|unroot|usb|tcpip|start-server|kill-server|reconnect)
            break
            ;;
        *)
            POSITIONAL_ARGS+=("$1") # save positional arg
            ARGS_TO_COMMAND+=("$1")
            shift # past argument
            ;;
    esac
done

while [[ $# -gt 0 ]]; do
    POSITIONAL_ARGS+=("$1") # save positional arg
    shift # past argument
done

set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters

if [[ "$ISSHELL" == "1" ]] && [[ "$NOTINTERACTIVESHELL" == "0" ]]; then
    if [[ "${ANDROID_SERIAL}" == "" ]]; then
        if [[ "$(adb "${ARGS_TO_COMMAND[@]}" devices | tail -n +2 | wc -l)" == 2 ]]; then
            ANDROID_SERIAL=$(adb "${ARGS_TO_COMMAND[@]}" devices | tail -n +2 | awk '{print $1}')
        fi
    fi
    if [[ "${ANDROID_SERIAL}" != "" ]]; then
        if adb "${ARGS_TO_COMMAND[@]}" devices | tail -n +2 | awk '{print $1}' | grep -E "^${ANDROID_SERIAL}\$"; then
            FIRSTINPUT="PS1=\"\${PS1}\$(echo -ne '\\033]7;adb://${ANDROID_SERIAL}\$PWD\\033\\\\') \""
            #(echo $FIRSTINPUT ; cat - ; echo -ne $'\04') | exec adb "$@"
            exec adb "$@" < <(echo $FIRSTINPUT ; cat - ; echo -ne $'\04')
        fi
    fi
fi

exec adb "$@"
